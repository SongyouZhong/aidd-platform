# AIDD Platform

> AI è¯ç‰©è®¾è®¡è®¡ç®—ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œè´Ÿè´£ç®¡ç†è®¡ç®—èµ„æºã€è°ƒåº¦ä»»åŠ¡ã€ç›‘æ§ Worker çŠ¶æ€ã€‚

ä¸ [aidd-toolkit](../aidd-toolkit) é…åˆä½¿ç”¨ï¼š
- **aidd-toolkit**: æä¾›å°è£…å¥½çš„è®¡ç®—å·¥å…·ï¼ˆQikPropã€Docking ç­‰ï¼‰
- **aidd-platform**: è´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€èµ„æºç®¡ç†ã€Worker ç¼–æ’

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AIDD Platform (æœ¬é¡¹ç›®)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  REST API â”‚  â”‚ Scheduler â”‚  â”‚  Worker   â”‚  â”‚  Monitor  â”‚        â”‚
â”‚  â”‚  (FastAPI)â”‚  â”‚  (è°ƒåº¦å™¨)  â”‚  â”‚  Manager  â”‚  â”‚  (ç›‘æ§)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                       â–¼              â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       Redis MQ (ä»»åŠ¡é˜Ÿåˆ—) + PostgreSQL (æŒä¹…åŒ–)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                         â–¼                         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ADMET Workerâ”‚          â”‚ ADMET Workerâ”‚          â”‚Docking Workerâ”‚
   â”‚(aidd-toolkit)â”‚          â”‚(aidd-toolkit)â”‚          â”‚(aidd-toolkit)â”‚
   â”‚  Node 1     â”‚          â”‚  Node 2     â”‚          â”‚  Node 3 GPU â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Redis MQ ä»»åŠ¡é˜Ÿåˆ—

### æ•°æ®ç»“æ„

| Key æ¨¡å¼ | ç±»å‹ | è¯´æ˜ |
|----------|------|------|
| `aidd:tasks:{id}` | Hash | ä»»åŠ¡è¯¦æƒ… |
| `aidd:queue:pending` | Sorted Set | å…¨å±€å¾…å¤„ç†é˜Ÿåˆ—ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ |
| `aidd:queue:service:{name}` | List | æœåŠ¡ä¸“ç”¨é˜Ÿåˆ— |
| `aidd:queue:running` | Set | è¿è¡Œä¸­çš„ä»»åŠ¡ |
| `aidd:queue:completed` | List | å·²å®Œæˆä»»åŠ¡ï¼ˆæœ€è¿‘1000æ¡ï¼‰ |
| `aidd:queue:failed` | List | å¤±è´¥ä»»åŠ¡ |
| `aidd:stats:*` | Hash | ç»Ÿè®¡ä¿¡æ¯ |

### ä»»åŠ¡æµè½¬

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   API æäº¤ä»»åŠ¡   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          aidd:queue:pending (ZSet)              â”‚
    â”‚    Score = ä¼˜å…ˆçº§ + æ—¶é—´æˆ³ï¼ˆå®ç°ä¼˜å…ˆçº§+FIFOï¼‰     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ admet é˜Ÿåˆ—â”‚       â”‚dockingé˜Ÿåˆ—â”‚       â”‚  å…¶ä»–    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      Worker æ¶ˆè´¹ (BRPOP/BZPOPMIN)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ aidd:queue:    â”‚
                    â”‚    running     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ completed â”‚  â”‚  failed  â”‚  â”‚ é‡è¯•å…¥é˜Ÿ  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
/aidd-platform
â”œâ”€â”€ app/                        # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                    # REST API
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py             # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ tasks.py        # ä»»åŠ¡ API
â”‚   â”‚       â”œâ”€â”€ jobs.py         # æ‰¹é‡ä½œä¸š API
â”‚   â”‚       â”œâ”€â”€ workers.py      # Worker ç®¡ç† API
â”‚   â”‚       â””â”€â”€ resources.py    # èµ„æºæŸ¥è¯¢ API
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py             # ä»»åŠ¡æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ job.py              # ä½œä¸šæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ worker.py           # Worker æ¨¡å‹
â”‚   â”‚   â””â”€â”€ resource.py         # èµ„æºæ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                # Pydantic Schema
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py
â”‚   â”‚   â”œâ”€â”€ job.py
â”‚   â”‚   â””â”€â”€ worker.py
â”‚   â”‚
â”‚   â”œâ”€â”€ scheduler/              # è°ƒåº¦å™¨æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ dispatcher.py       # ä»»åŠ¡åˆ†å‘å™¨
â”‚   â”‚   â”œâ”€â”€ resource_manager.py # èµ„æºç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ priority_queue.py   # ä¼˜å…ˆçº§é˜Ÿåˆ—
â”‚   â”‚
â”‚   â”œâ”€â”€ worker_manager/         # Worker ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ registry.py         # Worker æ³¨å†Œä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ heartbeat.py        # å¿ƒè·³æ£€æµ‹
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                     # æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ session.py          # æ•°æ®åº“ä¼šè¯
â”‚   â”‚   â””â”€â”€ repositories/       # æ•°æ®è®¿é—®å±‚
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ task_repo.py
â”‚   â”‚       â””â”€â”€ worker_repo.py
â”‚   â”‚
â”‚   â””â”€â”€ core/                   # æ ¸å¿ƒå·¥å…·
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ redis.py            # Redis å®¢æˆ·ç«¯
â”‚       â””â”€â”€ exceptions.py       # è‡ªå®šä¹‰å¼‚å¸¸
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.yml              # é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ alembic/                    # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ versions/
â”‚
â”œâ”€â”€ tests/                      # æµ‹è¯•
â”‚
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ alembic.ini
â””â”€â”€ pyproject.toml
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
export POSTGRES_HOST=10.18.85.10
export POSTGRES_PORT=30684
export REDIS_HOST=localhost
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

```bash
alembic upgrade head
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# ç”Ÿäº§æ¨¡å¼
docker-compose up -d
```

### 5. è®¿é—® API æ–‡æ¡£

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

## ğŸ“¡ API æ¦‚è§ˆ

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/v1/tasks` | åˆ›å»ºä»»åŠ¡ï¼ˆå…¥é˜Ÿ Redisï¼‰ |
| GET | `/api/v1/tasks/{id}` | è·å–ä»»åŠ¡è¯¦æƒ… |
| GET | `/api/v1/tasks/stats` | è·å–é˜Ÿåˆ—ç»Ÿè®¡ |
| DELETE | `/api/v1/tasks/{id}` | å–æ¶ˆä»»åŠ¡ |
| POST | `/api/v1/jobs` | åˆ›å»ºæ‰¹é‡ä½œä¸š |
| GET | `/api/v1/jobs/{id}` | è·å–ä½œä¸šçŠ¶æ€ |
| GET | `/api/v1/jobs/{id}/tasks` | è·å–ä½œä¸šä»»åŠ¡åˆ—è¡¨ |
| POST | `/api/v1/workers/register` | æ³¨å†Œ Worker |
| POST | `/api/v1/workers/{id}/heartbeat` | Worker å¿ƒè·³ |
| GET | `/api/v1/workers/stats` | é›†ç¾¤èµ„æºç»Ÿè®¡ |
| GET | `/api/v1/health` | å¥åº·æ£€æŸ¥ |

---

## ğŸ”— ä¸ aidd-toolkit é›†æˆ

### Worker æ¶ˆè´¹ç¤ºä¾‹

åœ¨ aidd-toolkit ä¸­åˆ›å»ºä»»åŠ¡æ¶ˆè´¹è€…ï¼š

```python
from app.mq import create_consumer, Task

# åˆ›å»ºæ¶ˆè´¹è€…
consumer = create_consumer(
    redis_url="redis://localhost:6379/0",
    services=["admet", "docking"],
    concurrency=4
)

# æ³¨å†Œå¤„ç†å™¨
@consumer.handler("admet")
async def handle_admet(task: Task) -> dict:
    # è°ƒç”¨ QikProp å¤„ç†
    result = await run_qikprop(task.input_data)
    return {"predictions": result}

@consumer.handler("docking")
async def handle_docking(task: Task) -> dict:
    # è°ƒç”¨ Docking å¤„ç†
    result = await run_docking(task.input_data)
    return {"poses": result}

# å¯åŠ¨æ¶ˆè´¹
await consumer.start()
```

### æäº¤ä»»åŠ¡ç¤ºä¾‹

```python
import httpx

async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://platform:8000/api/v1/tasks",
        json={
            "service": "admet",
            "name": "ADMET é¢„æµ‹",
            "priority": "normal",
            "input_data": {"smiles": ["CCO", "CC(=O)O"]},
            "parameters": {"mode": "qikprop"}
        }
    )
    task = response.json()
    print(f"Task ID: {task['id']}")
```
