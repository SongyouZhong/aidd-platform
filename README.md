# AIDD Platform

> AI è¯ç‰©è®¾è®¡è®¡ç®—ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œè´Ÿè´£ç®¡ç†è®¡ç®—èµ„æºã€è°ƒåº¦ä»»åŠ¡ã€ç›‘æ§ Worker çŠ¶æ€ã€‚

ä¸ [aidd-toolkit](../aidd-toolkit) é…åˆä½¿ç”¨ï¼š
- **aidd-toolkit**: æä¾›å°è£…å¥½çš„è®¡ç®—å·¥å…·ï¼ˆQikPropã€Docking ç­‰ï¼‰
- **aidd-platform**: è´Ÿè´£ä»»åŠ¡è°ƒåº¦ã€èµ„æºç®¡ç†ã€Worker ç¼–æ’

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **Redis**: ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰
- **PostgreSQL**: ä»»åŠ¡æŒä¹…åŒ–å­˜å‚¨
- **MinIO**: æ–‡ä»¶å¯¹è±¡å­˜å‚¨ï¼ˆè¾“å…¥/è¾“å‡ºæ–‡ä»¶ï¼‰

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AIDD Platform (æœ¬é¡¹ç›®)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  REST API â”‚  â”‚ Scheduler â”‚  â”‚  Worker   â”‚  â”‚  Monitor  â”‚        â”‚
â”‚  â”‚  (FastAPI)â”‚  â”‚  (è°ƒåº¦å™¨)  â”‚  â”‚  Manager  â”‚  â”‚  (ç›‘æ§)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                       â–¼              â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       Redis MQ (ä»»åŠ¡é˜Ÿåˆ—) + PostgreSQL (æŒä¹…åŒ–)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                         â–¼                         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ADMET Workerâ”‚          â”‚ ADMET Workerâ”‚          â”‚Docking Workerâ”‚
   â”‚(aidd-toolkit)â”‚          â”‚(aidd-toolkit)â”‚          â”‚(aidd-toolkit)â”‚
   â”‚  Node 1     â”‚          â”‚  Node 2     â”‚          â”‚  Node 3 GPU â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Redis MQ ä»»åŠ¡é˜Ÿåˆ—

### æ•°æ®ç»“æ„

| Key æ¨¡å¼ | ç±»å‹ | è¯´æ˜ |
|----------|------|------|
| `aidd:tasks:{id}` | Hash | ä»»åŠ¡è¯¦æƒ… |
| `aidd:queue:pending` | Sorted Set | å…¨å±€å¾…å¤„ç†é˜Ÿåˆ—ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ |
| `aidd:queue:service:{name}` | List | æœåŠ¡ä¸“ç”¨é˜Ÿåˆ— |
| `aidd:queue:running` | Set | è¿è¡Œä¸­çš„ä»»åŠ¡ |
| `aidd:queue:completed` | List | å·²å®Œæˆä»»åŠ¡ï¼ˆæœ€è¿‘1000æ¡ï¼‰ |
| `aidd:queue:failed` | List | å¤±è´¥ä»»åŠ¡ |
| `aidd:stats:*` | Hash | ç»Ÿè®¡ä¿¡æ¯ |

### ä»»åŠ¡æµè½¬

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   API æäº¤ä»»åŠ¡   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          aidd:queue:pending (ZSet)              â”‚
    â”‚    Score = ä¼˜å…ˆçº§ + æ—¶é—´æˆ³ï¼ˆå®ç°ä¼˜å…ˆçº§+FIFOï¼‰     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ admet é˜Ÿåˆ—â”‚       â”‚dockingé˜Ÿåˆ—â”‚       â”‚  å…¶ä»–    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      Worker æ¶ˆè´¹ (BRPOP/BZPOPMIN)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ aidd:queue:    â”‚
                    â”‚    running     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ completed â”‚  â”‚  failed  â”‚  â”‚ é‡è¯•å…¥é˜Ÿ  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
/aidd-platform
â”œâ”€â”€ app/                        # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                    # REST API
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py             # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ health.py       # å¥åº·æ£€æŸ¥ API
â”‚   â”‚       â”œâ”€â”€ tasks.py        # ä»»åŠ¡ API
â”‚   â”‚       â””â”€â”€ workers.py      # Worker ç®¡ç† API
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py             # ä»»åŠ¡æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ worker.py           # Worker æ¨¡å‹
â”‚   â”‚   â””â”€â”€ resource.py         # èµ„æºæ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ mq/                     # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ redis_client.py     # Redis å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ task_queue.py       # ä»»åŠ¡é˜Ÿåˆ—
â”‚   â”‚   â””â”€â”€ task_consumer.py    # ä»»åŠ¡æ¶ˆè´¹è€…
â”‚   â”‚
â”‚   â”œâ”€â”€ scheduler/              # è°ƒåº¦å™¨æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ dispatcher.py       # ä»»åŠ¡åˆ†å‘å™¨
â”‚   â”‚   â”œâ”€â”€ resource_manager.py # èµ„æºç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ priority_queue.py   # ä¼˜å…ˆçº§é˜Ÿåˆ—
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                # å­˜å‚¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ minio_client.py     # MinIO å¯¹è±¡å­˜å‚¨å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ storage.py          # ç»Ÿä¸€å­˜å‚¨æ¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ worker/                 # Worker å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ client.py           # Worker é€šä¿¡å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â””â”€â”€ db/                     # æ•°æ®åº“
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ session.py          # æ•°æ®åº“ä¼šè¯
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.yml              # é…ç½®æ–‡ä»¶ (YAML)
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ init-db.sql             # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ environment.yml             # Mamba/Conda ç¯å¢ƒé…ç½®
â””â”€â”€ requirements.txt            # pip ä¾èµ–ï¼ˆå¤‡ç”¨ï¼‰
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆä½¿ç”¨ mambaï¼‰

```bash
# ä½¿ç”¨ mamba åˆ›å»ºç¯å¢ƒ
mamba env create -f environment.yml

# æ¿€æ´»ç¯å¢ƒ
mamba activate aidd-platform

# æ›´æ–°ç¯å¢ƒï¼ˆå¦‚æœä¾èµ–æœ‰å˜åŒ–ï¼‰
mamba env update -f environment.yml --prune
```

> **æ³¨æ„**: å¦‚æœæ²¡æœ‰å®‰è£… mambaï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…:
> ```bash
> # ä½¿ç”¨ conda å®‰è£… mamba
> conda install -c conda-forge mamba
> 
> # æˆ–ä½¿ç”¨ miniforgeï¼ˆæ¨èï¼Œå·²å†…ç½® mambaï¼‰
> # https://github.com/conda-forge/miniforge
> ```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
export POSTGRES_HOST=10.18.85.10
export POSTGRES_PORT=30684
export REDIS_HOST=localhost
```

æˆ–è€…å¤åˆ¶å¹¶ç¼–è¾‘ `.env` æ–‡ä»¶:
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½®ç›¸å…³å‚æ•°
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

```bash
# ä½¿ç”¨ psql æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
PGPASSWORD=strongpassword psql -h 10.18.85.10 -p 30684 -U appuser -d aichemol -f scripts/init-db.sql

# æˆ–ä½¿ç”¨ Python
python -c "
import psycopg2
with open('scripts/init-db.sql', 'r') as f:
    sql = f.read()
conn = psycopg2.connect(
    host='10.18.85.10', port=30684,
    user='appuser', password='strongpassword',
    database='aichemol'
)
conn.autocommit = True
conn.cursor().execute(sql)
conn.close()
print('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ')
"
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼
uvicorn app.main:app --reload --host 0.0.0.0 --port 8333

# ç”Ÿäº§æ¨¡å¼
docker-compose up -d
```

### 5. è®¿é—® API æ–‡æ¡£

- Swagger UI: http://localhost:8333/docs
- ReDoc: http://localhost:8333/redoc

---

## ğŸ“¡ API æ¦‚è§ˆ

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/v1/tasks` | åˆ›å»ºä»»åŠ¡ï¼ˆå…¥é˜Ÿ Redisï¼‰ |
| GET | `/api/v1/tasks/{id}` | è·å–ä»»åŠ¡è¯¦æƒ… |
| GET | `/api/v1/tasks/stats` | è·å–é˜Ÿåˆ—ç»Ÿè®¡ |
| DELETE | `/api/v1/tasks/{id}` | å–æ¶ˆä»»åŠ¡ |
| POST | `/api/v1/workers/register` | æ³¨å†Œ Worker |
| POST | `/api/v1/workers/{id}/heartbeat` | Worker å¿ƒè·³ |
| GET | `/api/v1/workers/stats` | é›†ç¾¤èµ„æºç»Ÿè®¡ |
| GET | `/api/v1/health` | å¥åº·æ£€æŸ¥ |

---

## ğŸ“¦ MinIO å¯¹è±¡å­˜å‚¨

å¹³å°ä½¿ç”¨ MinIO ä½œä¸ºæ–‡ä»¶å­˜å‚¨åç«¯ï¼Œç”¨äºå­˜å‚¨ä»»åŠ¡çš„è¾“å…¥/è¾“å‡ºæ–‡ä»¶ã€‚

### é…ç½®

```yaml
# config/config.yml
storage:
  minio:
    endpoint: 172.19.80.100:9090
    access_key: admin
    secret_key: minio_test_password_2025
    bucket: aidd-files
    secure: false
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from app.storage import get_storage

storage = get_storage()

# ä¸Šä¼ æ–‡ä»¶åˆ° MinIO
storage.upload('tasks/input.csv', csv_data)
storage.upload_file('tasks/result.csv', '/local/path/result.csv')

# ä¸‹è½½æ–‡ä»¶
data = storage.download('tasks/input.csv')
storage.download_to_file('tasks/result.csv', '/local/path/result.csv')

# è·å–é¢„ç­¾å URLï¼ˆç”¨äºå®¢æˆ·ç«¯ç›´æ¥è®¿é—®ï¼‰
url = storage.get_presigned_url('tasks/result.csv', expires_hours=24)

# ä¸´æ—¶æ–‡ä»¶ï¼ˆæœ¬åœ°ç£ç›˜ï¼Œè®¡ç®—è¿‡ç¨‹ä½¿ç”¨ï¼‰
temp_path = storage.save_temp('temp.csv', data)
storage.download_to_temp('input.csv')  # ä» MinIO ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•
storage.clean_temp()  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

---

## ğŸ”— ä¸ aidd-toolkit é›†æˆ

### Worker ç”Ÿå‘½å‘¨æœŸ

aidd-toolkit ä¸­çš„ Worker é€šè¿‡ HTTP è°ƒç”¨æœ¬å¹³å°è¿›è¡Œæ³¨å†Œ/æ³¨é”€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Worker ç”Ÿå‘½å‘¨æœŸ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. å¯åŠ¨                                                     â”‚
â”‚     â””â”€â”€â–¶ POST /api/v1/workers/register                       â”‚
â”‚          è¿”å› worker_idï¼ŒçŠ¶æ€ = online                        â”‚
â”‚          åŒæ—¶æŒä¹…åŒ–åˆ° PostgreSQL workers è¡¨                   â”‚
â”‚                                                              â”‚
â”‚  2. å¿ƒè·³ (æ¯ 10 ç§’)                                           â”‚
â”‚     â””â”€â”€â–¶ POST /api/v1/workers/{id}/heartbeat                 â”‚
â”‚          æŠ¥å‘Š CPU/å†…å­˜ä½¿ç”¨ã€å½“å‰ä»»åŠ¡åˆ—è¡¨                       â”‚
â”‚          Platform æ›´æ–° last_heartbeat æ—¶é—´æˆ³                  â”‚
â”‚                                                              â”‚
â”‚  3. è¿è¡Œä¸­                                                   â”‚
â”‚     â””â”€â”€â–¶ ä» Redis æ¶ˆè´¹ä»»åŠ¡ (BRPOP aidd:queue:service:admet)  â”‚
â”‚     â””â”€â”€â–¶ æ‰§è¡Œè®¡ç®—ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€åˆ° Redis + PostgreSQL          â”‚
â”‚                                                              â”‚
â”‚  4. åœæ­¢ (Ctrl+C)                                            â”‚
â”‚     â””â”€â”€â–¶ DELETE /api/v1/workers/{worker_id}                  â”‚
â”‚          çŠ¶æ€ = offlineï¼Œæ•°æ®åº“åŒæ­¥æ›´æ–°                        â”‚
â”‚                                                              â”‚
â”‚  5. å¿ƒè·³è¶…æ—¶ (Platform è‡ªåŠ¨æ£€æµ‹)                              â”‚
â”‚     â””â”€â”€â–¶ è¶…è¿‡ 30 ç§’æ— å¿ƒè·³ï¼Œè‡ªåŠ¨æ ‡è®° Worker ä¸º offline         â”‚
â”‚     â””â”€â”€â–¶ è¯¥ Worker ä¸Šçš„ä»»åŠ¡é‡æ–°å…¥é˜Ÿç­‰å¾…è°ƒåº¦                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¿ƒè·³æœºåˆ¶

Worker ä¸ Platform ä¹‹é—´é€šè¿‡å¿ƒè·³ä¿æŒè¿æ¥çŠ¶æ€ï¼š

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `worker.heartbeat_interval` | 10 ç§’ | Worker å‘é€å¿ƒè·³é—´éš” |
| `heartbeat_timeout` | 30 ç§’ | Platform åˆ¤å®šè¶…æ—¶é˜ˆå€¼ |
| `heartbeat_check_interval` | 10 ç§’ | Platform æ£€æŸ¥å¿ƒè·³é—´éš” |

**å¿ƒè·³è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
POST /api/v1/workers/{worker_id}/heartbeat
Content-Type: application/json

{
  "used_cpu": 4,
  "used_memory_gb": 8.5,
  "used_gpu": 0,
  "used_gpu_memory_gb": 0,
  "current_tasks": ["task-uuid-1", "task-uuid-2"]
}
```

**è¶…æ—¶å¤„ç†æµç¨‹**ï¼š
```
Platform HeartbeatChecker (åå°ä»»åŠ¡)
    â”‚
    â”œâ”€â”€â–¶ æ¯ 10 ç§’æ£€æŸ¥æ‰€æœ‰ Worker çš„ last_heartbeat
    â”‚
    â”œâ”€â”€â–¶ å‘ç°è¶…æ—¶ Worker (now - last_heartbeat > 30s)
    â”‚       â”‚
    â”‚       â”œâ”€â”€â–¶ å†…å­˜ä¸­æ ‡è®° status = offline
    â”‚       â”‚
    â”‚       â””â”€â”€â–¶ æ•°æ®åº“åŒæ­¥æ›´æ–° status = offline
    â”‚
    â””â”€â”€â–¶ é‡æ–°è°ƒåº¦è¯¥ Worker ä¸Šçš„ä»»åŠ¡
```

### å¯åŠ¨ Worker

```bash
# åœ¨ aidd-toolkit ç›®å½•ä¸‹
cd /path/to/aidd-toolkit
mamba activate aidd-toolkit-admet
python -m services.admet_predict.wrapper
```

å¯åŠ¨åä¼šçœ‹åˆ°ï¼š
```
INFO | Worker æ³¨å†ŒæˆåŠŸ: <worker-id> (hostname)
INFO | ADMET Worker å·²åˆå§‹åŒ–ï¼ŒæœåŠ¡: admet, worker_id: <worker-id>
INFO | Worker å·²å¯åŠ¨ï¼ŒæœåŠ¡: admet
```

### æäº¤ä»»åŠ¡ç¤ºä¾‹

```bash
# é€šè¿‡ curl æäº¤ä»»åŠ¡
curl -X POST "http://localhost:8333/api/v1/tasks" \
  -H "Content-Type: application/json" \
  -d '{
    "service": "admet",
    "task_type": "qikprop",
    "name": "ADMETé¢„æµ‹",
    "input_params": {
      "smiles": ["CCO", "CC(=O)OC1=CC=CC=C1C(=O)O"]
    }
  }'
```

```python
# é€šè¿‡ Python æäº¤ä»»åŠ¡
import requests

response = requests.post(
    "http://localhost:8333/api/v1/tasks",
    json={
        "service": "admet",
        "task_type": "qikprop",
        "name": "ADMET é¢„æµ‹",
        "input_params": {"smiles": ["CCO", "CC(=O)O"]}
    }
)
task = response.json()
print(f"Task ID: {task['id']}")
```
